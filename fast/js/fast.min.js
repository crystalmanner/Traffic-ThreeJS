'use strict';var FAST={ID:0,SHAPE_POINT:1,SHAPE_LINE:2,SHAPE_CIRCLE:3,elapsed:0,timeScale:1,maxElapsed:0.0333333,frameRate:60,INTEGRATION_EULER:0,INTEGRATION_VERLET:1};FAST.integrationMethod=FAST.INTEGRATION_VERLET;FAST.visualDebugLines=[];FAST.visualDebug=!1;FAST.paused=!1;FAST.MINUTES_PER_SECOND=1/60;FAST.HOURS_PER_MINUTE=1/60;FAST.MILLS_PER_SECOND=1E3;FAST.reflect=function(a,b,c){var d=FAST.dot(a,b);c.x=a.x-2*b.x*d;c.y=a.y-2*b.y*d};
FAST.reflectPosition=function(a,b,c){b=FAST.dot(a.subtract(b),c);c=c.clone();c.x=-2*c.x*b;c.y=-2*c.y*b;a.x+=c.x;a.y+=c.y};FAST.samePoint=function(a,b,c){return a==b||Math.abs(a.x-b.x)<=c&&Math.abs(a.y-b.y)<=c?!0:!1};FAST.sameNumber=function(a,b,c){return Math.abs(a-b)<=c?!0:!1};FAST.timeOfCollision=function(a,b,c){b=b.subtract(a);return c.subtract(a).lng()/b.lng()};FAST.dot=function(a,b){return a.x*b.x+a.y*b.y};FAST.clamp=function(a,b,c){return a<b?b:a>c?c:a};
FAST.clampUInt=function(a,b,c){return a<b?b:a>c?c:Math.abs(Math.floor(a))};
FAST.formatTime=function(a){var b="";if(0>=a)return"0:00";var c=Math.floor(a*FAST.MINUTES_PER_SECOND*FAST.HOURS_PER_MINUTE),d=Math.floor(a*FAST.MINUTES_PER_SECOND)-c/FAST.HOURS_PER_MINUTE,e=Math.floor(a)-d/FAST.MINUTES_PER_SECOND;a=Math.round((a-Math.floor(a))*FAST.MILLS_PER_SECOND);0<c&&(b=10<=c?b+(c+":"):b+("0"+c+":"));0<d&&(b=10<=d?b+(d+":"):b+("0"+d+":"));b=10<=e?b+(e+":"):b+("0"+e+":");return 100<=a?b+a:10<=a?b+("0"+a):0<a?b+("00"+a):b+"000"};FAST.V2=function(a,b){this.x=a||0;this.y=b||0};
FAST.V2.prototype={constructor:FAST.V2,lng:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},set:function(a,b){this.x=a||0;this.y=b||0},normalize:function(a){if(0===this.x&&0===this.y||0===a)return new FAST.V2(0,0);var b=Math.atan2(this.y,this.x);this.x=Math.cos(b)*a;this.y=Math.sin(b)*a},add:function(a){return new FAST.V2(this.x+a.x,this.y+a.y)},subtract:function(a){return new FAST.V2(this.x-a.x,this.y-a.y)},interpolate:function(a,b,c){return new FAST.V2(a.x+(b.x-a.x)*c,a.y+(b.y-a.y)*c)},
reset:function(){this.y=this.x=0;return this},clone:function(){return new FAST.V2(this.x,this.y)},divideScalar:function(a){0!==a?(a=1/a,this.x*=a,this.y*=a):this.y=this.x=0;return this}};FAST.Matrix=function(a,b,c,d,e,f){this.a=a||1;this.b=b||0;this.c=c||0;this.d=d||1;this.tx=e||0;this.ty=f||0};
FAST.Matrix.prototype={constructor:FAST.Matrix,set:function(a,b,c,d,e,f){this.a=a||1;this.b=b||0;this.c=c||0;this.d=d||1;this.tx=e||0;this.ty=f||0},transformPoint:function(a){return new FAST.V2(this.a*a.x+this.c*a.y+this.tx,this.b*a.x+this.d*a.y+this.ty)}};FAST.lineSegments=function(a,b,c,d,e){var f=(d.y-c.y)*(b.x-a.x)-(d.x-c.x)*(b.y-a.y);if(0.001>Math.abs(f))return null;d=((d.x-c.x)*(a.y-c.y)-(d.y-c.y)*(a.x-c.x))/f;c=((b.x-a.x)*(a.y-c.y)-(b.y-a.y)*(a.x-c.x))/f;if(0>d||1<d||0>c||1<c)return null;c=new FAST.V2;e&&(c=e);c.x=a.x+d*(b.x-a.x);c.y=a.y+d*(b.y-a.y);return c};
FAST.rayCircle=function(a,b,c,d,e){var f=a.subtract(c);c=FAST.dot(f,b);d=FAST.dot(f,f)-d*d;if(0<d&&0<c)return null;d=c*c-d;if(0>d)return null;c=-c-Math.sqrt(d);0>c&&(c=0);null==e&&(e=new FAST.V2);e.x=a.x+b.x*c;e.y=a.y+b.y*c;return e};
FAST.lineSegmentCircle=function(a,b,c,d,e){e.reset();var f=b.subtract(a),h=f.lng();f.normalize(1);var g=a.subtract(c);c=FAST.dot(g,f);d=FAST.dot(g,g)-d*d;0<d&&0<c?e.intersectCount=0:(d=c*c-d,0>d?e.intersectCount=0:(g=-c-Math.sqrt(d),0>g&&(g=0),g>h?e.intersectCount=0:(e.point1.x=a.x+f.x*g,e.point1.y=a.y+f.y*g,0==d?(e.intersectCount=1,e.point2.x=e.point1.x,e.point2.y=e.point1.y):(e.intersectCount=2,g=-c+Math.sqrt(d),g>h?(e.point2.x=b.x,e.point2.y=b.y):(e.point2.x=a.x+f.x*g,e.point2.y=a.y+f.y*g)))))};
FAST.closestPointInLineSegmentCircleIntersect=function(a,b){var c=new FAST.RayCircleResult;FAST.lineSegmentCircle(a.position,a.end,b.position,b.radius,c);if(0==c.intersectCount)return-1;for(var d=(new FAST.V2).interpolate(c.point1,c.point2,0.5),c=[c.point1,c.point2,d],d=b.radius,e=c.length,f;e--;)f=c[e],f=f.subtract(b.position).lng(),f<d&&(d=f);return b.radius-d};
FAST.resolveMovingPointAndFixedLine=function(a,b,c){FAST.reflectPosition(a.nextPosition,c,b.normal);FAST.visualDebug&&FAST.visualDebugLines.push([a.position.x,a.position.y,c.x,c.y]);a.position.x=c.x;a.position.y=c.y;FAST.reflect(a.velocity,b.normal,a.nextVelocity);a.velocity.x=a.nextVelocity.x;a.velocity.y=a.nextVelocity.y};
FAST.resolveMovingPointAndFixedCircle=function(a,b,c){var d=new FAST.V2;d.x=c.x-b.position.x;d.y=c.y-b.position.y;d.normalize(1);FAST.reflectPosition(a.nextPosition,c,d);FAST.visualDebug&&FAST.visualDebugLines.push([a.position.x,a.position.y,c.x,c.y]);a.position.x=c.x;a.position.y=c.y;FAST.reflect(a.velocity,d,a.nextVelocity);a.velocity.x=a.nextVelocity.x;a.velocity.y=a.nextVelocity.y};FAST.Group=function(){this.exists=this.visible=this.active=!0;this.num=0;this.members=[]};
FAST.Group.prototype={constructor:FAST.Group,destroy:function(){for(var a=this.members.length;a--;)this.members[a].destroy();this.members=null;this.exists=!1},add:function(a){this.members[this.members.length]=a;this.num=this.members.length},recycle:function(){for(var a=this.members.length;a--;)if(!this.members[a].exists)return this.members[a].exists=!0,this.members[a];return null},preUpdate:function(){for(var a=this.num;a--;)this.members[a].active&&this.members[a].preUpdate()},update:function(){for(var a=
this.num;a--;)this.members[a].update()},postUpdate:function(){for(var a=this.num;a--;)this.members[a].postUpdate()},preDraw:function(){for(var a=this.num;a--;)this.members[a].visible&&this.members[a].preDraw()},draw:function(){for(var a=this.num;a--;)this.members[a].visible&&this.members[a].draw()},debugDraw:function(){for(var a=this.num;a--;)this.members[a].debugDraw()}};FAST.World=function(a){this.world=this.island=null;FAST.frameRate=a||60;this.total=0;this.init()};
FAST.World.prototype={constructor:FAST.World,init:function(){this.island=new FAST.Island;this.world=new FAST.WorldGroup;this.world.addIsland(this.island)},clear:function(){this.world.destroy();this.init()},add:function(a){this.world.add(a);this.island.add(a)},step:function(){var a=Date.now(),b=(a-this.total)/1E3;this.total=a;FAST.elapsed=b;FAST.elapsed>FAST.maxElapsed&&(FAST.elapsed=FAST.maxElapsed);FAST.elapsed*=FAST.timeScale;this.world.preUpdate();this.world.update();this.world.postUpdate()}};
FAST.WorldGroup=function(){FAST.Group.call(this);this.islands=[]};FAST.WorldGroup.prototype=Object.create(FAST.Group.prototype);FAST.WorldGroup.prototype.preUpdate=function(){for(var a=this.islands.length;a--;)this.islands[a].solve();for(a=this.num;a--;)this.members[a].active&&this.members[a].preUpdate()};FAST.WorldGroup.prototype.addIsland=function(a){this.islands[this.islands.length]=a};FAST.Obj=function(a,b){this.exists=this.visible=this.active=!0;this.fixed=!1;this.id=FAST.ID++;a=a||0;b=b||0;this.position=new FAST.V2(a,b);this.nextPosition=new FAST.V2(a,b);this.point=new FAST.V2;this.prevY=this.prevX=this.h=this.w=0;this.acceleration=new FAST.V2;this.velocity=new FAST.V2;this.nextVelocity=new FAST.V2;this.maxVelocity=new FAST.V2(25E3,25E3);this.center=new FAST.V2(this.x,this.y);this.radians=0;this.shape=null;this.fillColor=this.lineColor=16777215;this.alpha=1;this.velColor=255;
this.accColor=16711680;this.predictMotionFunction=1;this.didFirstUpdate=!1;Object.defineProperty(this,"x",{get:function(){return this.position.x},set:function(a){this.position.x=a}});Object.defineProperty(this,"y",{get:function(){return this.position.y},set:function(a){this.position.y=a}});Object.defineProperty(this,"nextX",{get:function(){return this.nextPosition.x},set:function(a){this.nextPosition.x=a}});Object.defineProperty(this,"nextY",{get:function(){return this.nextPosition.y},set:function(a){this.nextPosition.y=
a}})};
FAST.Obj.prototype={constructor:FAST.Obj,destroy:function(){this.shape=this.center=this.maxVelocity=this.velocity=this.acceleration=null;this.exists=!1},reset:function(a,b){this.x=a;this.y=b;this.didFirstUpdate=!1},preUpdate:function(){if(this.fixed||!this.didFirstUpdate)this.nextX=this.x,this.nextY=this.y,this.nextVelocity.x=this.velocity.x,this.nextVelocity.y=this.velocity.y;this.updateMotion();this.updateCenter()},update:function(){},postUpdate:function(){this.fixed||(0==this.predictMotionFunction&&this.predictMotionEuler(),
1==this.predictMotionFunction&&this.predictMotionVerlet());this.didFirstUpdate=!0},updateMotion:function(){this.prevX=this.x;this.prevY=this.y;this.x=this.nextX;this.y=this.nextY;this.position.set(this.x,this.y);this.velocity.x=this.nextVelocity.x;this.velocity.y=this.nextVelocity.y;FAST.visualDebug&&FAST.visualDebugLines.push([this.prevX,this.prevY,this.x,this.y])},updateCenter:function(){this.center.set(0.5*this.w,0.5*this.h)},preDraw:function(){},draw:function(){},debugDraw:function(){},setIntegrationMethod:function(a){0==
a&&(this.predictMotionFunction=0);1==a&&(this.predictMotionFunction=1)},predictMotionEuler:function(){this.nextVelocity.x=this.velocity.x+this.acceleration.x*FAST.elapsed;this.nextVelocity.y=this.velocity.y+this.acceleration.y*FAST.elapsed;this.nextVelocity.x=FAST.clamp(this.nextVelocity.x,-this.maxVelocity.x,this.maxVelocity.x);this.nextVelocity.y=FAST.clamp(this.nextVelocity.y,-this.maxVelocity.y,this.maxVelocity.y);this.nextX=this.x+this.nextVelocity.x*FAST.elapsed;this.nextY=this.y+this.nextVelocity.y*
FAST.elapsed},predictMotionVerlet:function(){var a,b;a=this.acceleration.x*FAST.elapsed*0.5;this.nextVelocity.x=this.velocity.x+a;b=this.nextVelocity.x*FAST.elapsed;this.nextVelocity.x=FAST.clamp(this.nextVelocity.x,-this.maxVelocity.x,this.maxVelocity.x);this.nextVelocity.x+=a;this.nextX=this.x+b;a=this.acceleration.y*FAST.elapsed*0.5;this.nextVelocity.y=this.velocity.y+a;this.nextVelocity.y=FAST.clamp(this.nextVelocity.y,-this.maxVelocity.y,this.maxVelocity.y);b=this.nextVelocity.y*FAST.elapsed;
this.nextVelocity.y+=a;this.nextY=this.y+b}};FAST.Heap=function(a){this.data=[];this.heapLength=0};
FAST.Heap.prototype={constructor:FAST.Heap,clear:function(){for(var a=this.heapLength;a--;)null!==this.data[a]&&this.data[a].destroy();this.data=[];this.heapLength=0},isEmpty:function(){return 0===this.heapLength?!0:!1},insert:function(a){var b=this.heapLength,c=Math.floor((b-1)/2);this.data[b]=a;for(this.heapLength++;0!==b&&0>this.compareByTime(this.data[b],this.data[c]);)a=this.data[b],this.data[b]=this.data[c],this.data[c]=a,b=c,c=Math.floor((b-1)/2)},removeMin:function(){if(0===this.heapLength)return null;
this.heapLength--;var a=this.data[0];this.data[0]=this.data[this.heapLength];this.data[this.heapLength]=null;this.heapify(0);return a},heapify:function(a){a=a||0;var b=2*a+1,c=2*a+2,b=b<this.heapLength&&0<=this.compareByTime(this.data[a],this.data[b])?b:a;c<this.heapLength&&0<=this.compareByTime(this.data[b],this.data[c])&&(b=c);b!=a&&(c=this.data[a],this.data[a]=this.data[b],this.data[b]=c,this.heapify(b))},compareByTime:function(a,b){return a.time-b.time}};FAST.Island=function(){this.collisions=new FAST.Heap(this.compareByTime);this.doubleDict=[];this.collisionList=new FAST.Group;this.collectCollisionsCount=0;this.collectCollisionsMax=15;this.collisionsResolvedThisFrame=0;this.points=[];this.lines=[];this.circles=[];this.result=new FAST.RayCircleResult};
FAST.Island.prototype={constructor:FAST.Island,add:function(a){switch(a.type){case FAST.SHAPE_POINT:this.points.push(a);break;case FAST.SHAPE_LINE:this.lines.push(a);break;case FAST.SHAPE_CIRCLE:this.circles.push(a)}},solve:function(){this.prepare();this.collectCollisions(0);this.collectCollisionsCount++;this.solveCollisions()},prepare:function(){this.collectCollisionsCount=this.collisionsResolvedThisFrame=0;this.collisions.clear();this.doubleDict=[]},compareByTime:function(a,b){return a.time-b.time},
collectCollisions:function(a){var b,c,d,e;for(b=this.points.length;b--;){d=this.points[b];for(c=this.circles.length;c--;)if(e=this.circles[c],FAST.lineSegmentCircle(d.position,d.nextPosition,e.position,e.radius,this.result),0<this.result.intersectCount){var f=this.recycleCollision();f.init(d,e,2);f.pointOfCollision.x=this.result.point1.x;f.pointOfCollision.y=this.result.point1.y;f.time=a+FAST.timeOfCollision(d.position,d.nextPosition,this.result.point1);this.addCollision(f)}for(c=this.lines.length;c--;){e=
this.lines[c];var h=FAST.lineSegments(d.position,d.nextPosition,e.position,e.end,null);null!==h&&(f=this.recycleCollision(),f.init(d,e,1),f.pointOfCollision.x=h.x,f.pointOfCollision.y=h.y,f.time=a+FAST.timeOfCollision(d.position,d.nextPosition,h),this.addCollision(f))}}},addCollision:function(a){this.collisions.insert(a);this.collisionList.add(a);a.obj1 in this.doubleDict||(this.doubleDict[a.obj1]=[]);a.obj2 in this.doubleDict[a.obj1]||(this.doubleDict[a.obj1][a.obj2]=-1)},contains:function(a,b){return-1<
a.indexOf(b)},recycleCollision:function(){var a=this.collisionList.recycle();null===a&&(a=new FAST.Collision);return a},solveCollisions:function(){for(var a,b;!this.collisions.isEmpty();)if(a=this.collisions.removeMin(),FAST.shouldIgnoreCollision(a,this.doubleDict[a.obj1][a.obj2]))a.destroy();else if(a.resolveCollision(),b=a.time,this.doubleDict[a.obj1][a.obj2]=b,this.collisionsResolvedThisFrame++,a.destroy(),this.collisions.clear(),this.collectCollisions(b),this.collectCollisionsCount++,this.collectCollisionsCount>=
this.collectCollisionsMax)break}};FAST.shouldIgnoreCollision=function(a,b){if(-1==b)return!1;if(FAST.sameNumber(a.time,b,1.25E-4))return!0;a.time<b&&console.log("Investigate how this happened...");return!1};FAST.RayCircleResult=function(a){this.intersectCount=0;this.point1=new FAST.V2;this.point2=new FAST.V2};FAST.RayCircleResult.prototype={constructor:FAST.RayCircleResult,reset:function(){this.intersectCount=0;this.point1.x=0;this.point1.y=0;this.point2.x=0;this.point2.y=0}};FAST.Collision=function(){this.exists=this.visible=this.active=!0;this.resolveType=1;this.time=0;this.pointOfCollision=new FAST.V2;this.obj2=this.obj1=null};
FAST.Collision.prototype={constructor:FAST.Collision,init:function(a,b,c){this.time=0;this.obj1=a;this.obj2=b;this.resolveType=c},resolveCollision:function(){1===this.resolveType&&FAST.resolveMovingPointAndFixedLine(this.obj1,this.obj2,this.pointOfCollision);2===this.resolveType&&FAST.resolveMovingPointAndFixedCircle(this.obj1,this.obj2,this.pointOfCollision)},destroy:function(){this.exists=!1}};FAST.Point=function(a,b,c){FAST.Obj.call(this,a,b);this.type=FAST.SHAPE_POINT};FAST.Point.prototype=Object.create(FAST.Obj.prototype);FAST.Line=function(a,b,c,d){FAST.Obj.call(this,a,b);this.type=FAST.SHAPE_LINE;this.end=new FAST.V2(c,d);this.w=this.end.x-this.x;this.h=this.end.y-this.y;this.direction=new FAST.V2;this.normalizedDirection=new FAST.V2;this.normal=new FAST.V2;this.normalM=new FAST.Matrix;this.setNormalMatrixDirection(-Math.PI/2);this.updateNormal()};FAST.Line.prototype=Object.create(FAST.Obj.prototype);
FAST.Line.prototype.destroy=function(){this.shape=this.center=this.maxVelocity=this.velocity=this.acceleration=this.end=null;this.exists=!1};FAST.Line.prototype.setNormalMatrixDirection=function(a){this.normalM.a=Math.cos(a);this.normalM.b=-Math.sin(a);this.normalM.c=Math.sin(a);this.normalM.d=Math.cos(a)};
FAST.Line.prototype.preUpdate=function(){if(this.fixed||!this.didFirstUpdate)this.nextX=this.x,this.nextY=this.y,this.nextVelocity.x=this.velocity.x,this.nextVelocity.y=this.velocity.y;this.updateMotion();this.updateCenter();this.end.x=this.x+this.w;this.end.y=this.y+this.h};FAST.Line.prototype.update=function(){this.updateNormal()};FAST.Line.prototype.setEnd=function(a,b){this.end.set(a,b);this.w=this.end.x-this.x;this.h=this.end.y-this.y};
FAST.Line.prototype.getDirection=function(){this.direction.x=this.end.x-this.x;this.direction.y=this.end.y-this.y;return this.direction};FAST.Line.prototype.getNormalizedDirection=function(){this.normalizedDirection.x=this.end.x-this.x;this.normalizedDirection.y=this.end.y-this.y;this.normalizedDirection.normalize(1);return this.normalizedDirection};
FAST.Line.prototype.updateNormal=function(){0==this.w&&0==this.h?(this.normal.x=0,this.normal.y=0):(this.point.x=this.w,this.point.y=this.h,this.point.normalize(1),this.point=this.normalM.transformPoint(this.point),this.normal.x=this.point.x,this.normal.y=this.point.y)};FAST.Line.prototype.intersects=function(a,b){return FAST.lineSegments(a.position,a.end,b.position,b.end)};FAST.Circle=function(a,b,c){FAST.Obj.call(this,a,b);this.type=FAST.SHAPE_CIRCLE;this.radius=c;this.tmpPoint=new FAST.V2};
FAST.Circle.prototype=Object.create(FAST.Obj.prototype);FAST.Circle.prototype.diameter=function(){return 2*this.radius};FAST.Circle.prototype.updateCenter=function(){this.center.set(0,0)};FAST.Circle.prototype.overlap=function(a,b){this.tmpPoint.set(a.x-b.x,a.y-b.y);return this.tmpPoint.lng()<=a.radius+b.radius?!0:!1};FAST.Circle.prototype.intersection=function(a,b){this.tmpPoint.set(a.x-b.x,a.y-b.y);var c=this.tmpPoint.lng();return a.radius+b.radius-c};
FAST.Circle.prototype.intersects=function(a,b){return 0<=this.intersection(a,b)};
